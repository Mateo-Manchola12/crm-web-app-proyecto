---
import { tiers } from '../data/pricing'
---

<form
    action="/contact"
    method="post"
    id="contact-form"
    class="w-5/6 max-w-2xl space-y-4 md:grid md:grid-cols-2 md:gap-6"
    aria-labelledby="contact-form-title"
>
    <!-- Honeypot field (hidden from users) -->
    <div class="hidden">
        <label for="honeypot">No llenar este campo</label>
        <input
            type="text"
            id="honeypot"
            name="honeypot"
            tabindex="-1"
            autocomplete="off"
            aria-hidden="true"
        />
    </div>

    <!-- Nombre -->
    <div>
        <label for="name" class="block text-sm font-medium text-gray-700">Nombre</label>
        <input
            type="text"
            id="name"
            name="name"
            required
            aria-required="true"
            aria-label="Nombre"
            class="focus:border-primary focus:ring-primary hover:border-primary hover:ring-primary/30 shadow-primary/30 mt-1 block w-full rounded-md border-gray-300 bg-gray-50 px-3 py-2 shadow-lg transition-all duration-300 hover:bg-purple-50 hover:ring-1 focus:bg-purple-100 focus:ring-2 focus:ring-offset-2 sm:text-sm"
            style="outline: none;"
        />
    </div>

    <!-- País -->
    <div>
        <label for="country" class="block text-sm font-medium text-gray-700">País</label>
        <div class="relative">
            <select
                id="country"
                name="country"
                aria-required="true"
                aria-label="País"
                class="focus:border-primary focus:ring-primary hover:border-primary hover:ring-primary/30 shadow-primary/30 mt-1 block w-full appearance-none rounded-md border-gray-300 bg-gray-50 px-3 py-2 shadow-lg transition-all duration-300 hover:bg-purple-50 hover:ring-1 focus:bg-purple-100 focus:ring-2 focus:ring-offset-2 sm:text-sm"
                style="outline: none;"
            >
                <option value="">Selecciona tu país</option>
                <option value="mx">México</option>
                <option value="es">España</option>
                <option value="ar">Argentina</option>
                <option value="co">Colombia</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                <svg
                    class="h-5 w-5 text-gray-400"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                    aria-hidden="true"
                >
                    <path
                        fill-rule="evenodd"
                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                        clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Correo -->
    <div>
        <label for="email" class="block text-sm font-medium text-gray-700">Correo electrónico</label
        >
        <input
            type="email"
            id="email"
            name="email"
            required
            aria-required="true"
            aria-label="Correo electrónico"
            class="focus:border-primary focus:ring-primary hover:border-primary hover:ring-primary/30 shadow-primary/30 mt-1 block w-full rounded-md border-gray-300 bg-gray-50 px-3 py-2 shadow-lg transition-all duration-300 hover:bg-purple-50 hover:ring-1 focus:bg-purple-100 focus:ring-2 focus:ring-offset-2 sm:text-sm"
            style="outline: none;"
        />
    </div>

    <!-- Teléfono -->
    <div>
        <label for="phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
        <input
            type="tel"
            id="phone"
            name="phone"
            required
            aria-required="true"
            aria-label="Teléfono"
            class="focus:border-primary focus:ring-primary hover:border-primary hover:ring-primary/30 shadow-primary/30 mt-1 block w-full rounded-md border-gray-300 bg-gray-50 px-3 py-2 shadow-lg transition-all duration-300 hover:bg-purple-50 hover:ring-1 focus:bg-purple-100 focus:ring-2 focus:ring-offset-2 sm:text-sm"
            style="outline: none;"
        />
    </div>

    <!-- Nombre de la empresa -->
    <div>
        <label for="company" class="block text-sm font-medium text-gray-700"
            >Nombre de la empresa</label
        >
        <input
            type="text"
            id="company"
            name="company"
            aria-required="true"
            aria-label="Nombre de la empresa"
            class="focus:border-primary focus:ring-primary hover:border-primary hover:ring-primary/30 shadow-primary/30 mt-1 block w-full rounded-md border-gray-300 bg-gray-50 px-3 py-2 shadow-lg transition-all duration-300 hover:bg-purple-50 hover:ring-1 focus:bg-purple-100 focus:ring-2 focus:ring-offset-2 sm:text-sm"
            style="outline: none;"
        />
    </div>

    <!-- Plan de interés -->
    <div>
        <label for="plan" class="block text-sm font-medium text-gray-700">Plan de interés</label>
        <div class="relative">
            <select
                id="plan"
                name="plan"
                aria-required="true"
                aria-label="Plan de interés"
                class="focus:border-primary focus:ring-primary hover:border-primary hover:ring-primary/30 shadow-primary/30 mt-1 block w-full appearance-none rounded-md border-gray-300 bg-gray-50 px-3 py-2 shadow-lg transition-all duration-300 hover:bg-purple-50 hover:ring-1 focus:bg-purple-100 focus:ring-2 focus:ring-offset-2 sm:text-sm"
                style="outline: none;"
            >
                <option value="">Selecciona un plan</option>
                {
                    Object.keys(tiers).map((tier) => (
                        <option class="capitalize" value={tier}>
                            {tier}
                        </option>
                    ))
                }
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                <svg
                    class="h-5 w-5 text-gray-400"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                    aria-hidden="true"
                >
                    <path
                        fill-rule="evenodd"
                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                        clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Tamaño de la empresa -->
    <div>
        <label for="company-size" class="block text-sm font-medium text-gray-700"
            >Tamaño de la empresa</label
        >
        <div class="relative">
            <select
                id="company-size"
                name="company-size"
                aria-required="true"
                aria-label="Tamaño de la empresa"
                class="focus:border-primary focus:ring-primary hover:border-primary hover:ring-primary/30 shadow-primary/30 mt-1 block w-full appearance-none rounded-md border-gray-300 bg-gray-50 px-3 py-2 shadow-lg transition-all duration-300 hover:bg-purple-50 hover:ring-1 focus:bg-purple-100 focus:ring-2 focus:ring-offset-2 sm:text-sm"
                style="outline: none;"
            >
                <option value="">Selecciona el tamaño</option>
                <option value="small">Pequeña (1-10 empleados)</option>
                <option value="medium">Mediana (11-50 empleados)</option>
                <option value="large">Grande (50+ empleados)</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                <svg
                    class="h-5 w-5 text-gray-400"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                    aria-hidden="true"
                >
                    <path
                        fill-rule="evenodd"
                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                        clip-rule="evenodd"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Botón de envío -->
    <div class="md:col-span-2">
        <button
            type="submit"
            aria-label="Enviar formulario"
            class="from-primary/80 to-primary hover:from-primary hover:to-primary/80 focus:ring-primary w-full rounded-md bg-gradient-to-r px-4 py-2 text-white shadow-lg transition-colors duration-300 focus:outline-none"
        >
            Enviar
        </button>
        <label class="flex items-center justify-center">
            <input
                type="checkbox"
                name="privacy-policy"
                checked
                required
                aria-required="true"
                aria-label="Aceptar política de privacidad"
                class="text-primary focus:ring-primary h-2 w-2 rounded border-gray-300"
            />
            <!-- Política de privacidad -->
            <span class="ml-2 text-center text-xs text-gray-700">
                Acepto la <a href="/privacy-policy" class="text-primary underline"
                    >política de privacidad</a
                >.
            </span>
        </label>
    </div>
</form>
<script>
    import { $, $$ } from '../js/dom-selector'

    const errorClass = 'ring-2 ring-red-500 shadow-red-500 bg-red-100'
    const successClass = 'ring-2 ring-green-500 shadow-green-500 bg-green-100'

    const regex = {
        email: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
        phone: /^\+?[0-9]{10,15}$/,
        name: /^[a-zA-ZÀ-ÿ\s]{1,40}$/,
        company: /^[a-zA-ZÀ-ÿ\s&-]{1,40}$/,
        country: /^[a-zA-ZÀ-ÿ\s]{1,40}$/,
        plan: /^[a-zA-ZÀ-ÿ\s]{1,40}$/,
        'company-size': /^[a-zA-ZÀ-ÿ\s]{1,40}$/,
    }

    document.addEventListener('astro:page-load', () => {
        const form = $('#contact-form') as HTMLFormElement
        const inputs = $$('input, select') as NodeListOf<HTMLInputElement>

        form.addEventListener('submit', (event) => {
            let isValid = true

            inputs.forEach((input) => {
                const value = input.value.trim()
                const type = input.type
                const name = input.name

                input.classList.remove(...errorClass.split(' '))
                input.classList.remove(...successClass.split(' '))

                if (name === 'honeypot') if (value) return (isValid = false)
                if (type === 'checkbox')
                    if (!input.checked) {
                        isValid = false
                        toggleInputState(input, false)
                        return
                    } else return

                if (!input.hasAttribute('required') && !value) return
                if (input.hasAttribute('required') && !value)
                    return toggleInputState(input, (isValid = false))

                if (!checkRegExpression(input, regex[name as keyof typeof regex])) isValid = false
            })

            if (!isValid) event.preventDefault()
        })
    })

    function toggleInputState(input: HTMLInputElement, isValid: boolean) {
        if (isValid) {
            input.classList.add(...successClass.split(' '))
            input.classList.remove(...errorClass.split(' '))
        } else {
            input.classList.add(...errorClass.split(' '))
            input.classList.remove(...successClass.split(' '))
        }
    }

    function checkRegExpression(input: HTMLInputElement, regex: RegExp) {
        console.log(input, regex)
        const result = regex.test(input.value.trim())
        toggleInputState(input, result)
        return result
    }
</script>
